<!-- face_capture.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EventPass - Face Registration</title>
    <!-- Google Fonts (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 70px;
        }

        .navbar {
            background-color: #fff;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .navbar .fw-bold {
            font-family: 'Poppins', sans-serif;
        }

        .icon-circle {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: red;
            color: white;
            font-size: 12px;
            border-radius: 50%;
            padding: 2px 5px;
        }

        .icon-group>div {
            margin-left: 20px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .bottom-nav a {
            text-decoration: none;
            color: #6c757d;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bottom-nav a.active {
            color: #6f42c1;
        }

        .bottom-nav i {
            font-size: 20px;
        }

        /* Face capture specific styles */
        .face-capture-container {
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }

        #video {
            width: 100%;
            max-width: 500px;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
        }

        #captured-face {
            width: 100%;
            max-width: 500px;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .face-preview {
            position: relative;
            margin: 0 auto 15px;
            width: 100%;
            max-width: 500px;
        }

        .capture-btn {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
        }

        .retake-btn {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .instructions {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px auto;
            max-width: 500px;
            text-align: left;
        }

        .instructions h5 {
            color: #6f42c1;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        #message {
            font-weight: 600;
            margin-top: 15px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .already-registered {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        .face-registered-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 15px;
        }

        .face-box {
            position: absolute;
            border: 3px solid #6f42c1;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-light px-3 sticky-top shadow-sm">
        <div class="d-flex justify-content-between align-items-center w-100">
            <div class="d-flex align-items-center">
                <i class="bi bi-ticket-fill text-primary fs-3 me-2"></i>
                <span class="fw-bold fs-5">EventPass</span>
            </div>

            <!-- Notifications & Profile Icons -->
            <div class="d-flex align-items-center icon-group">
                <!-- Notifications -->
                <div class="dropdown">
                    <a class="icon-circle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-bell text-dark fs-5"></i>
                        {% if notifications|length > 0 %}
                        <span class="notification-badge">{{ notifications|length }}</span>
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% for notif in notifications %}
                        <li>
                            <a class="dropdown-item{% if not notif.is_read %} fw-bold{% endif %}"
                                href="{{ notif.url|default:'#' }}">
                                {{ notif.message }}
                                <br>
                                <small class="text-muted">{{ notif.created_at|date:"M d, Y H:i" }}</small>
                            </a>
                        </li>
                        {% empty %}
                        <li><span class="dropdown-item text-muted">No notifications</span></li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Profile -->
                <div class="dropdown">
                    <a class="icon-circle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-fill text-dark fs-5"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'view_profile' %}">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="{% url 'logout' %}">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="face-capture-container">
        <h4 class="mb-4">Register Your Face</h4>

        <!-- Already Registered Section -->
        <div id="already-registered" class="already-registered" style="display: none;">
            <div class="face-registered-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h5>Face Already Registered</h5>
            <p>Your face has been successfully registered for event access.</p>
            <p class="text-muted">Last registered: <span id="registration-date"></span></p>
        </div>

        <!-- Registration Form (hidden by default until we check status) -->
        <div id="registration-form" style="display: none;">
            <div class="instructions">
                <h5><i class="bi bi-info-circle"></i> Instructions</h5>
                <ul>
                    <li>Position your face in the center of the frame</li>
                    <li>Ensure good lighting on your face</li>
                    <li>Remove sunglasses or hats</li>
                    <li>Keep a neutral expression</li>
                    <li>Make sure no one else is in the frame</li>
                </ul>
            </div>

            <div class="face-preview">
                <video id="video" width="640" height="480" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <img id="captured-face" alt="Captured face preview">
                <div id="face-box" class="face-box"></div>
            </div>

            <button id="capture" class="btn btn-primary capture-btn">
                <i class="bi bi-camera-fill"></i> Capture Image
            </button>
            <button id="retake" class="btn btn-secondary retake-btn">
                <i class="bi bi-arrow-repeat"></i> Retake Photo
            </button>
            <p id="message"></p>
        </div>

        <!-- Success message (shown only after first registration) -->
        <div id="success-message" class="already-registered" style="display: none;">
            <div class="face-registered-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h5>Face Registered Successfully!</h5>
            <p>Your face has been successfully registered for event access.</p>
            <p class="text-muted">Registered: <span id="success-timestamp"></span></p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Checking registration status...</p>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="{% url 'user_dashboard' %}">
            <i class="bi bi-house-door"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'event_list' %}">
            <i class="bi bi-calendar-event"></i>
            <span>Events</span>
        </a>
        <a href="{% url 'my_tickets' %}">
            <i class="bi bi-ticket-perforated"></i>
            <span>Tickets</span>
        </a>
        <a href="{% url 'capture_face' %}" class="active">
            <i class="bi bi-camera"></i>
            <span>Face Reg.</span>
        </a>
        <a href="{% url 'view_profile' %}">
            <i class="bi bi-person"></i>
            <span>Profile</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedFace = document.getElementById('captured-face');
            const captureButton = document.getElementById('capture');
            const retakeButton = document.getElementById('retake');
            const message = document.getElementById('message');
            const registrationForm = document.getElementById('registration-form');
            const alreadyRegistered = document.getElementById('already-registered');
            const loadingState = document.getElementById('loading-state');
            const successMessage = document.getElementById('success-message');

            let currentStream = null;
            let isProcessing = false;

            // First check registration status
            checkFaceRegistration();

            function checkFaceRegistration() {
                $.ajax({
                    url: '{% url "check_face_registration" %}',
                    type: 'GET',
                    success: function (response) {
                        loadingState.style.display = 'none';

                        if (response.registered) {
                            // Case 1: Face was previously registered
                            showAlreadyRegistered(response.registration_date);
                        } else {
                            // Case 2: No registration exists yet
                            showRegistrationForm();
                        }
                    },
                    error: function () {
                        loadingState.style.display = 'none';
                        showError('Error checking registration status. Please refresh the page.');
                    }
                });
            }

            function showAlreadyRegistered(registrationDate) {
                // For subsequent visits - show "already registered"
                alreadyRegistered.style.display = 'block';
                document.getElementById('registration-date').textContent = registrationDate;
                successMessage.style.display = 'none'; // Hide success message
            }

            function showRegistrationForm() {
                // For first-time registration
                registrationForm.style.display = 'block';
                alreadyRegistered.style.display = 'none';
                initializeCamera();
            }

            function initializeCamera() {
                if (!navigator.mediaDevices?.getUserMedia) {
                    showError('Camera access is not supported by your browser');
                    captureButton.disabled = true;
                    return;
                }

                navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                }).then(stream => {
                    currentStream = stream;
                    video.srcObject = stream;
                }).catch(err => {
                    const errorMsg = err.name === 'NotAllowedError' ?
                        'Camera access was denied. Please enable camera permissions.' :
                        'Error accessing camera: ' + err.message;
                    showError(errorMsg);
                    captureButton.disabled = true;
                });
            }

            captureButton.addEventListener('click', function () {
                if (isProcessing) return;
                processFaceCapture();
            });

            function processFaceCapture() {
                isProcessing = true;
                updateButtonState(true);
                message.textContent = '';

                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);

                    showCapturedFacePreview();

                    $.ajax({
                        url: '{% url "capture_face" %}',
                        type: 'POST',
                        data: {
                            image: canvas.toDataURL('image/jpeg', 0.8),
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                // Case 3: Just completed first-time registration
                                handleSuccessfulFirstRegistration();
                            } else {
                                handleCaptureError(response.message);
                            }
                        },
                        error: function (xhr) {
                            handleCaptureError(xhr.responseJSON?.message || 'Error processing request');
                        },
                        complete: function () {
                            isProcessing = false;
                        }
                    });
                } catch (err) {
                    handleCaptureError(err.message);
                }
            }

            function handleSuccessfulFirstRegistration() {
                // Special handling for first-time registration success
                registrationForm.style.display = 'none';
                alreadyRegistered.style.display = 'none';
                successMessage.style.display = 'block';
                document.getElementById('success-timestamp').textContent = 'Just now';

                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
            }

            function showCapturedFacePreview() {
                capturedFace.src = canvas.toDataURL('image/jpeg');
                video.style.display = 'none';
                capturedFace.style.display = 'block';
            }

            retakeButton.addEventListener('click', function () {
                resetCaptureUI();
            });

            function resetCaptureUI() {
                video.style.display = 'block';
                capturedFace.style.display = 'none';
                retakeButton.style.display = 'none';
                message.textContent = '';
                updateButtonState(false);
            }

            function updateButtonState(isProcessing) {
                captureButton.disabled = isProcessing;
                captureButton.innerHTML = isProcessing ?
                    '<span class="spinner-border spinner-border-sm"></span> Processing...' :
                    '<i class="bi bi-camera-fill"></i> Capture Image';
            }

            function showError(msg) {
                message.textContent = msg;
                message.className = 'error';
            }

            function handleCaptureError(msg) {
                showError(msg);
                // Reset UI for another attempt
                video.style.display = 'block';
                capturedFace.style.display = 'none';
                retakeButton.style.display = 'none';
                updateButtonState(false);
            }
        });
    </script>

</body>

</html>